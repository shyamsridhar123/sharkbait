# Implement main agent loop

| Field | Value |
|-------|-------|
| ID | SB-004.01 |
| Parent | SB-004 |
| Status | Completed |
| Priority | high |
| Created | 2025-01-13 |
| Updated | 2026-01-28 |

## Description

Core agent loop with **stall detection and recovery** (inspired by Magentic-One):

**Basic Loop:**
- Receive user input or tool results
- Build context with system prompt, history, tools
- Send to LLM and stream response
- Parse tool calls and execute
- Loop until task complete or stop signal

**Dual-Ledger Progress Tracking:**
- `TaskLedger`: Facts, assumptions, plan (outer loop)
- `ProgressLedger`: Step history, stall count (inner loop)
- Stall detection: 3 consecutive steps without progress triggers re-planning
- Recovery strategies: agent switch, re-plan, escalate

**Safety Limits:**
- MAX_ITERATIONS = 50 (absolute limit)
- STALL_THRESHOLD = 3 (steps without progress)
- MAX_REPLANS = 2 (re-planning attempts before escalation)

## Acceptance Criteria

- [ ] Async generator-based agent loop
- [ ] **Dual-ledger system (TaskLedger + ProgressLedger)**
- [ ] **Stall detection with configurable threshold**
- [ ] **Recovery strategies (re-plan, agent switch, escalate)**
- [ ] Max iterations limit (default: 50)
- [ ] Graceful interruption handling
- [ ] Token usage tracking
- [ ] Proper error recovery
- [ ] Integration with ContextManager

## References

- TRD Section 3.2: Agent Loop
- AGENT_ARCHITECTURE.md Section 4.1.1: Dual-Ledger Progress Tracking
